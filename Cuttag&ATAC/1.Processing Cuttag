#!/bin/bash
# ============================================================
# Title:    CUT&Tag Alignment and Preprocessing Pipeline
# System:   Ubuntu 22.04.1
# Purpose:  Align CUT&Tag paired-end reads to human (hg38) and
#            spike-in (gamma) reference genomes, generate
#            cleaned BAM files for downstream analysis.
# ============================================================

# Root directory containing raw FASTQ files
WORKDIR="/path/to/rawdata"

# Bowtie2 genome index (hg38 human reference)
REF_HUMAN="/path/to/reference/hg38_index"

# Bowtie2 spike-in index
REF_SPIKEIN="/path/to/reference/spike-in_index"

# Number of threads for parallel processing
THREADS=8

Cuttaglist=()

# Main loop
for i in "${Cuttaglist[@]}"; do
  echo "Processing ${i} ..."

  # Step 1: Trim reads
  trim_galore --cores ${THREADS} -q 25 --phred33 --fastqc --paired \
    ${i}_R1.fq.gz ${i}_R2.fq.gz --gzip

  # Step 2: Alignment to human genome
  bowtie2 --very-sensitive-local --no-unal --no-mixed --no-discordant --phred33 \
    -I 10 -X 700 -p ${THREADS} \
    -x ${REF_HUMAN} \
    -1 ${i}_R1_val_1.fq.gz -2 ${i}_R2_val_2.fq.gz \
    -S ${i}_bowtie2.sam &> ${i}_bowtie2.txt

  # Step 2b: Alignment to spike-in genome
  bowtie2 --very-sensitive-local --no-unal --no-mixed --no-discordant --phred33 \
    -I 10 -X 700 -p ${THREADS} \
    -x ${REF_SPIKEIN} \
    -1 ${i}_R1_val_1.fq.gz -2 ${i}_R2_val_2.fq.gz \
    -S ${i}_bowtie2_spikein.sam &> ${i}_bowtie2_spikein.txt

  # Step 3: Convert SAM to BAM, sort, and index
  samtools view -bS -F 0x04 -@ ${THREADS} ${i}_bowtie2.sam > ${i}_mapped.bam
  samtools sort -@ ${THREADS} ${i}_mapped.bam -o ${i}_sorted.bam
  samtools index -@ ${THREADS} ${i}_sorted.bam

  # Step 4: Extract standard chromosomes and generate clean BAM
  samtools view -@ ${THREADS} -b ${i}_sorted.bam \
    chr1 chr2 chr3 chr4 chr5 chr6 chr7 chr8 chr9 chr10 \
    chr11 chr12 chr13 chr14 chr15 chr16 chr17 chr18 chr19 \
    chr20 chr21 chr22 chrX chrY \
    | samtools sort -@ ${THREADS} -o ${i}_clean.bam -
  samtools index -@ ${THREADS} ${i}_clean.bam

  echo "${i} completed."
done
